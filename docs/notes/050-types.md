# 型の各論

WIP

型の種類や、型がとりうる値、適用可能な操作などを定める。

## ユニット型

`()` (unit) は型であり、値は定数 `()` の1つに限られる。この値のサイズは 0 ビットである。

`()` を含めて、サイズが 0 ビットの型を **ゼロサイズ型** と総称する。

## bool 型

`bool` は型であり、値は定数 `true`, `false` の2つに限られる。この値のサイズは 1 バイトである。

同値と順序の比較演算と、論理演算が定まる。順序は `false < true`。

`bool` 型は符号つき整数型、符号なし整数型と相互にキャストできる:

- bool → 整数:
    - false → 0
    - true → 1
- 整数 → bool:
    - 0 → false
    - 0 以外 → true

## 符号つき整数型

組み込みの符号つき整数型は固定のビット幅を持ち、2の補数で表現される。isize のビット幅はコンパイル対象によって決まり、ポインタのビット幅に等しい。

| 名前   | ビット幅   | 意味    |
|:------|----------:|:--------------|
| i8    | 8         | 符号つき整数  |
| i16   | 16        | 符号つき整数  |
| i32   | 32        | 符号つき整数  |
| i64   | 64        | 符号つき整数  |
| isize | ptr       | 符号つき整数  |

符号つき整数型を総称して `{signed}` と表記する。`{signed}` の併合型を `iNN` とおく。(`{signed}` は型の総称であって、それ自体は型ではない。一方、`iNN` は型であり、型検査の途中で使う。)

符号つき整数型は互いに部分型関係を持たない。isize は、もしビット幅が一致しても i32 や i64 とは異なる型であり、部分型関係を持たない。

算術演算、ビット演算、同値および順序の比較演算が定まる。

符号つき整数型、符号なし整数型、浮動小数点数型、文字型の値は、`as` 演算子により相互に変換できる。

isize はポインタ型との和・差の右辺になれる。

TODO: i128, u128 を追加

## 符号なし整数型

組み込みの符号なし整数型は固定のビット幅を持つ。usize のビット幅は isize と同じくポインタの幅に等しい。

| 名前   | ビット幅   | 意味    |
|:------|----------:|:--------------|
| u8    | 8         | 符号なし整数  |
| u16   | 16        | 符号なし整数  |
| u32   | 32        | 符号なし整数  |
| u64   | 64        | 符号なし整数  |
| usize | ptr       | 符号なし整数  |

符号なし整数型を総称して `{unsigned}` と表記する。`{unsigned}` の併合型を uNN とおく。

算術演算、ビット演算、同値および順序の比較演算が定まる。

usize は `as` 演算子によりポインタ型と相互に変換でき、ポインタの和・差の右辺になれる。

## 浮動小数点数型

浮動小数点数型は固定のビット幅を持つ。値の表現は IEEE-754 により定義される。

| 名前   | ビット幅   | 意味    |
|:------|----------:|:--------------|
| f32   | 32        | 浮動小数点数  |
| f64   | 64        | 浮動小数点数  |

浮動小数点数型を総称して `{float}` と表記する。`{float}` の併合型を fNN とおく。

算術演算、同値および順序の比較演算が定まる。

浮動小数点数型の値は `as` 演算子により相互に変換でき、

TODO: f16, f128 を追加

## 文字型

文字型 `c8`, `c16`, `c32` の実行時の表現は、それぞれ `u8`, `u16`, `u32` に等しい。

| 名前   | ビット幅   | 意味    |
|:------|----------:|:----------------|
| c8    | 8         | UTF-8 コードユニット  |
| c16   | 16        | UTF-16 コードユニット |
| c32   | 32        | UTF-32 コードユニット |

型を総称して `{char}` と表記する。`{char}` の和を cNN とおく。

注意: 文字型の値が所定のエンコーディングのコードユニットとして有効かどうかはコンパイル時にも実行時にも検査されないし、違反してもプログラムの誤りとはみなされない。文字型の配列が所定のエンコーディングの文字列として有効かどうかも同様に、違反しても誤りとはみなされない。

## 特殊な型: unknown

`unknown` は型である。値のサイズは静的に決定できない (不定サイズ型)。

T を型とするとき、`*T` は `*unknown` の部分型である。`*T` と `*unknown` は `as` 演算子により相互にキャストできる。`*mut T` と `*mut unknown` も同様。

備考: `*unknown` はC言語の `const void*` に相当し、`*mut unknown` は `void*` に相当する。

TODO: 標準ライブラリに `std::ptr::transmute` を追加して `as` による `*unknown` からのダウンキャストを廃止する。

## 特殊な型: never

`!` (never) は型であり、値を持たない。

`!` 型の式を評価するとき、「評価が停止して何らかの値が得られる」ことはない。代わりに、無限ループに陥って停止しない、関数から return する、プログラム自体が終了する、などの現象が起こる。

値を持たない型は `!` に限らない。例えば、enum 宣言 `enum MyNever {}` により定義される enum 型 `MyNever` も値を持たない。`!` を含めて、値を持たない型を **発散型** と総称する。

`!` はあらゆる型の部分型である (`! <: T`)。ただし、他の発散型はそうではない。

## 読み取り専用のポインタ型

T を型とする。`*const T` は読み取り専用のポインタ型である。`*T` は `*const T` に等しい。

型 T に関する部分型関係は共変 (covariant) に遺伝する。

## 可変なポインタ型

T を型とする。`*mut T` は可変なポインタ型である。

型 T に関する部分型関係は遺伝しない (invariant)。`*T` の部分型である。

備考: `*mut T` のような読み書き可能な参照を共変・反変にすると、例えば `Cat <: Animal, Dog <: Animal` のような部分型関係があるとき `cat: *mut Cat` に対して `*(cat as *mut Animal) = dog as Animal` のような整合性のない書き込みを許容してしまう。

QUESTION: `*mut T <: *mut unknown` は問題ない？ (`unknown` に対する書き込みは常に不正であるため)

## enum 型

enum 宣言 `enum T ...` は新しい型 T を導入する。これを enum 型と呼ぶ。

### バリアントの型

定数バリアントの型:

- 型注釈があれば、その型である。
- 型注釈がなくて初期化式があるとき、構文的に初期化式はリテラルか名前式に制限されていて、定数バリアントの型はそれの型である。
- 型注釈と初期化式がなければ、`()` である。

レコードバリアントは新しい struct 型を導入し、バリアントの型はこれである。

### enum 型の表現

すべてのバリアントが発散型なら、T も発散型である。(バリアントを持たない場合も発散型である。)

T がちょうど1つのバリアントからなり、そのバリアントがゼロサイズ型であるか、初期化式を持たない定数バリアントなら、T もゼロサイズ型である。

発散型でもゼロサイズ型でもない enum 型をタグつきユニオン型と呼ぶ。以下、T はタグつきユニオン型とする。

タグつきユニオン型はタグと呼ばれる整数を持つ。

TODO: enum 型のタグの型や値、enum 型の値のサイズ、構築、分解について述べる

## struct 型

struct 宣言 `struct T ...` は新しい型 T を導入する。これを struct 型と呼ぶ。

## 併合型

WIP

併合型は構文的に定義することはできず、型検査の途中に出現する。

併合型を構成する型の部分型は、併合型の部分型でもある:

```
    U = union(T, ...),
    S <: T => S <: U
```

## 参考

- C言語の算術型: [Arithmetic types](https://en.cppreference.com/w/c/language/arithmetic_types)
- C言語の標準ライブラリの型: [Type support](https://en.cppreference.com/w/c/types)
